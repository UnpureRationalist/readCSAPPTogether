# 第五章

## 1、定义 CPE

引入度量标准每元素的周期数——CPE，作为一种表示程序性能并指导代码改进的方法。CPE 需要通过对某段程序使用不同的元素数量重复执行，再利用最小二乘法进行估计。一个估算 CPE 的示例图如下：

![image](https://user-images.githubusercontent.com/56211928/144694730-ba6664c1-ddd4-49df-8021-44537c008579.png)

通过最小二乘法拟合，得到 psum1 = 368 + 9.0n，psum2 = 368 + 6.0n，故知 psum1 和 psum2 的 CPE 分别是 9.0 和 6.0。

## 2、理解现代处理器

在代码级上，看上去似乎是一次执行一条指令，每条指令都包括从寄存器或内存取值，执行一个操作，并把结果存回到一个寄存器或内存位置。在实际的处理器中，是同时对多条指令求值的，这个现象称为指令级并行。现代处理器采用超标量技术，即利用多个执行相同操作的功能部件，再每个时钟周期执行多个操作。流水线采用乱序方式，指令的执行顺序不一定于机器程序中的顺序一致。

### 2.1 功能单元的性能

以 Intel Core i7 Haswell 为例，它执行某些算术运算所需的时钟周期如下：

![image](https://user-images.githubusercontent.com/56211928/144695023-1dc61a53-a1e9-407a-8a61-90c9126d1afd.png)

对于每个操作，由以下三种变量来刻画：

- 延迟 (latency), 它表示完成运算所需要的总时间
- 发射时间 (issue time), 它表示两个连续的同类型的运算之间需要的最小时钟周期数
- 容量 (capacity), 它表示能够执行该运算的功能单元的数量

发射时间为 1 的功能单元被称为是完全流水化的，每个周期可以开始一个新的运算。在没有数据冲突的情况下，完全流水化的指令可以认为在 1 个周期内即可执行完毕。

对于一个容量为 C，发射时间为 I 的操作来说，处理器可能获得的最大吞吐量为每个时钟周期 C / I 个操作。

### 2.2 程序性能上限

- 功能界限给出了任何必须严格按照顺序完成运算的函数所需要的最小 CPE 值。
- 吞吐量界限给出了理论上 CPE 的最小值。

对于整数和浮点数的一些操作，Intel Core i7 Haswell 的性能如下：

![image](https://user-images.githubusercontent.com/56211928/144695409-6f056f5b-182d-46d0-95c7-e61997b1c980.png)

## 3、程序优化示例

以下代码对数组 v 执行一系列操作，将结果存储在 dest 中，其中 IDENT 为 0 或 1，分别对应 OP 为 + 或 * ：

![image](https://user-images.githubusercontent.com/56211928/144695491-86c69756-4d05-4fbe-928a-8823767178dc.png)

以上代码的效率并不高，以下对其执行一系列代码变化：

- 消除循环的低效率：将循环内部的 i < vec_length(v) 外提。
- 减少过程调用：利用 get_vec_start 获取数组首地址，无需使用循环内部的 get_vec_element 来获取数组元素。
- 消除不必要的内存引用：创建一个新的临时变量 acc，迭代时对 acc 进行更新，最后将 acc 赋给 \*dest

现在得到如下代码：

![image](https://user-images.githubusercontent.com/56211928/144696067-1bfd0863-2620-4a14-90b9-f1d842247e6f.png)





